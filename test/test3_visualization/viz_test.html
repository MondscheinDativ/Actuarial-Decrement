<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>精算可视化测试</title>
  <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .chart-container { height: 600px; border: 1px solid #eee; }
    .status { position: fixed; top: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>精算可视化测试</h1>
    <div id="mortalityChart" class="chart-container"></div>
    
    <h2>代码关联性验证</h2>
    <ul id="validationResults"></ul>
  </div>

  <script>
    // 产品代码关联性验证
    const validations = [
      { id: 'renderForecastResults', file: 'analysis.js', status: 'pending' },
      { id: 'generatePlotlyData', file: 'analysis.js', status: 'pending' },
      { id: 'forecastChart', file: 'analysis.html', status: 'pending' },
      { id: 'plotlyVersion', file: 'analysis.html', status: 'pending' }
    ];
    
    // 模拟验证结果（实际实现需通过API）
    setTimeout(() => {
      validations.forEach(v => {
        v.status = 'verified';
        const li = document.createElement('li');
        li.innerHTML = `✅ ${v.id} <small>(${v.file})</small>`;
        document.getElementById('validationResults').appendChild(li);
      });
    }, 1500);
    
    // Plotly 版本验证
    const EXPECTED_VERSION = "2.14.0";
    if (typeof Plotly === 'undefined') {
      showError('Plotly 未加载');
    } else if (Plotly.version !== EXPECTED_VERSION) {
      showWarning(`版本不匹配: 期望 ${EXPECTED_VERSION}, 实际 ${Plotly.version}`);
    } else {
      console.log("✅ Plotly 版本验证通过");
    }

    // 加载配置并渲染图表
    fetch('viz_config.json')
      .then(response => response.json())
      .then(config => {
        Plotly.newPlot('mortalityChart', config.data, config.layout);
      })
      .catch(error => {
        showError(`配置加载失败: ${error.message}`);
      });
    
    function showError(message) {
      const chartDiv = document.getElementById('mortalityChart');
      chartDiv.innerHTML = `<div style="color:red;padding:50px;text-align:center;">
        <h2>错误</h2><p>${message}</p></div>`;
    }
    
    function showWarning(message) {
      const warning = document.createElement('div');
      warning.className = 'status';
      warning.style.background = '#ff9800';
      warning.textContent = `⚠️ ${message}`;
      document.body.appendChild(warning);
    }
  </script>
</body>
</html>
